<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Магазин</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --main-color: #3498db; --bg-color: #f5f5f5; --card-bg: #ffffff; --text-color: #000; }
        body { font-family: -apple-system, sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; padding-bottom: 80px; }
        
        /* СЕТКА ТОВАРОВ */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card img { width: 100%; border-radius: 8px; aspect-ratio: 1/1; object-fit: cover; }
        .price { color: #2ecc71; font-weight: bold; margin-top: 5px; }
        
        /* КНОПКИ */
        .btn { background: var(--main-color); color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer; }
        .btn-outline { background: transparent; border: 2px solid var(--main-color); color: var(--main-color); }
        .btn-green { background: #2ecc71; }
        
        /* ЭКРАНЫ */
        .view { display: none; padding: 15px; }
        .active { display: block; }

        /* КАРТОЧКА ТОВАРА */
        .gallery { overflow-x: scroll; display: flex; gap: 10px; scroll-snap-type: x mandatory; }
        .gallery img { width: 100%; flex-shrink: 0; scroll-snap-align: center; border-radius: 10px; }
        .sizes { display: flex; gap: 10px; margin: 15px 0; }
        .size-opt { border: 1px solid #ddd; padding: 10px; border-radius: 8px; flex: 1; text-align: center; }
        .size-opt.selected { background: var(--main-color); color: white; border-color: var(--main-color); }

        /* КОРЗИНА И ОФОРМЛЕНИЕ */
        .cart-item { display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px; margin-bottom: 10px; border-radius: 8px; }
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .summary { background: white; padding: 15px; border-radius: 10px; margin-top: 20px; }
        .row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .total { font-weight: 800; font-size: 18px; border-top: 1px solid #eee; padding-top: 10px; margin-top: 10px; }

        /* QR ОПЛАТА */
        .qr-container { text-align: center; padding: 20px; background: white; border-radius: 15px; }
        .qr-container img { max-width: 200px; }
    </style>
</head>
<body>

    <div id="view-catalog" class="view active">
        <h2 style="text-align:center;">Каталог</h2>
        <div class="grid" id="catalog-grid"></div>
        <button id="cart-btn-float" class="btn" style="position:fixed; bottom:20px; left:5%; width:90%; display:none;" onclick="goCart()">Корзина (<span id="cart-count">0</span>)</button>
    </div>

    <div id="view-product" class="view">
        <button class="btn btn-outline" onclick="goCatalog()" style="margin-bottom:10px;">← Назад</button>
        <div class="gallery" id="p-gallery"></div>
        <h2 id="p-title"></h2>
        <div id="p-price" class="price" style="font-size:24px;"></div>
        <p id="p-desc" style="color:#666; font-size:14px;"></p>
        
        <h4>Выберите размер:</h4>
        <div class="sizes" id="p-sizes"></div>
        
        <button class="btn" onclick="addToCart()">В корзину</button>
    </div>

    <div id="view-cart" class="view">
        <button class="btn btn-outline" onclick="goCatalog()">← В каталог</button>
        <h2>Корзина</h2>
        <div id="cart-items"></div>
        
        <div style="margin-top:20px;">
            <input type="text" id="promo-input" placeholder="Введите промокод">
            <button class="btn btn-outline" onclick="applyPromo()">Применить</button>
            <div id="promo-msg" style="font-size:12px; margin-top:5px;"></div>
        </div>

        <button class="btn" onclick="goCheckout()">Перейти к оформлению</button>
    </div>

    <div id="view-checkout" class="view">
        <button class="btn btn-outline" onclick="goCart()">← Назад</button>
        <h2>Оформление</h2>
        
        <label><input type="checkbox" id="policy" checked> Согласен с политикой обработки ПД</label>
        
        <h4>Доставка</h4>
        <input type="text" id="city" placeholder="Город (например, Москва)" onchange="calcDelivery()">
        <select id="delivery-type" onchange="calcDelivery()">
            <option value="sdek_pvz">СДЭК до ПВЗ (300р)</option>
            <option value="sdek_curier">СДЭК Курьер (500р)</option>
        </select>
        <input type="text" id="pvz-address" placeholder="Адрес ПВЗ или Доставки">
        
        <h4>Получатель</h4>
        <input type="text" id="fio" placeholder="ФИО">
        <input type="tel" id="phone" placeholder="Телефон">

        <div class="summary">
            <div class="row"><span>Товары:</span> <span id="sum-goods">0 ₽</span></div>
            <div class="row"><span>Доставка:</span> <span id="sum-delivery">0 ₽</span></div>
            <div class="row" style="color:red;"><span>Скидка:</span> <span id="sum-discount">0 ₽</span></div>
            <div class="row total"><span>ИТОГО:</span> <span id="sum-total">0 ₽</span></div>
        </div>

        <button class="btn btn-green" onclick="goPayment()">Оформить и Оплатить</button>
    </div>

    <div id="view-payment" class="view">
        <h2>Оплата заказа</h2>
        <div class="qr-container">
            <img src="https://upload.wikimedia.org/wikipedia/commons/d/d0/QR_code_for_mobile_English_Wikipedia.svg" alt="QR">
            <p>Отсканируйте код в приложении банка</p>
            <h3 id="pay-amount"></h3>
        </div>
        <button class="btn btn-green" onclick="finishOrder()">✅ Я ОПЛАТИЛ(А)</button>
        <button class="btn btn-outline" onclick="goCheckout()">Назад</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- ДАННЫЕ (ЗАМЕНИ НА СВОИ ИЗ EXCEL) ---
        const products = [
            { id: 1, name: "Футболка Black", price: 1500, desc: "Крутая футболка, хлопок 100%.", sizes: ["S","M","L"], imgs: ["https://via.placeholder.com/400/000000/fff", "https://via.placeholder.com/400/333"] },
            { id: 2, name: "Худи White", price: 3500, desc: "Теплое худи на флисе.", sizes: ["XS","S","M"], imgs: ["https://via.placeholder.com/400/ffffff/000", "https://via.placeholder.com/400/eee"] }
        ];

        const promoCodes = {
            "START": 10, // 10%
            "VIP": 20    // 20%
        };
        // ----------------------------------------

        let cart = [];
        let currentProduct = null;
        let selectedSize = null;
        let activePromo = null;

        // Инициализация
        function init() {
            const grid = document.getElementById('catalog-grid');
            products.forEach(p => {
                grid.innerHTML += `
                    <div class="card" onclick="openProduct(${p.id})">
                        <img src="${p.imgs[0]}">
                        <div style="font-weight:bold; margin-top:5px;">${p.name}</div>
                        <div class="price">${p.price} ₽</div>
                    </div>`;
            });
        }
        init();

        // Навигация
        function showView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            window.scrollTo(0,0);
        }
        function goCatalog() { showView('view-catalog'); }
        function goCart() { renderCart(); showView('view-cart'); }
        
        function goCheckout() {
            if(cart.length === 0) return tg.showAlert("Корзина пуста");
            calcDelivery();
            showView('view-checkout');
        }

        // Карточка товара
        function openProduct(id) {
            currentProduct = products.find(p => p.id === id);
            selectedSize = null;
            
            document.getElementById('p-title').innerText = currentProduct.name;
            document.getElementById('p-price').innerText = currentProduct.price + ' ₽';
            document.getElementById('p-desc').innerText = currentProduct.desc;
            
            // Галерея
            const gal = document.getElementById('p-gallery');
            gal.innerHTML = currentProduct.imgs.map(src => `<img src="${src}">`).join('');
            
            // Размеры
            const sDiv = document.getElementById('p-sizes');
            sDiv.innerHTML = currentProduct.sizes.map(s => 
                `<div class="size-opt" onclick="selectSize(this, '${s}')">${s}</div>`
            ).join('');
            
            showView('view-product');
        }

        function selectSize(el, size) {
            document.querySelectorAll('.size-opt').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            selectedSize = size;
        }

        function addToCart() {
            if(!selectedSize) return tg.showAlert("Выберите размер!");
            cart.push({ ...currentProduct, size: selectedSize });
            document.getElementById('cart-count').innerText = cart.length;
            document.getElementById('cart-btn-float').style.display = 'block';
            tg.showAlert("Добавлено в корзину!");
            goCatalog();
        }

        // Корзина
        function renderCart() {
            const cDiv = document.getElementById('cart-items');
            cDiv.innerHTML = '';
            cart.forEach((item, idx) => {
                cDiv.innerHTML += `
                    <div class="cart-item">
                        <div><b>${item.name}</b> (${item.size})<br>${item.price} ₽</div>
                        <button style="color:red; background:none; border:none;" onclick="remItem(${idx})">✖</button>
                    </div>`;
            });
        }
        function remItem(idx) { cart.splice(idx, 1); renderCart(); }

        function applyPromo() {
            const code = document.getElementById('promo-input').value.toUpperCase();
            if (promoCodes[code]) {
                activePromo = { code: code, discount: promoCodes[code] };
                document.getElementById('promo-msg').innerText = `✅ Скидка ${activePromo.discount}% применена!`;
                document.getElementById('promo-msg').style.color = 'green';
            } else {
                activePromo = null;
                document.getElementById('promo-msg').innerText = "❌ Промокод не найден";
                document.getElementById('promo-msg').style.color = 'red';
            }
        }

        // Расчеты
        function calcDelivery() {
            const type = document.getElementById('delivery-type').value;
            // Упрощенная логика для фронтенда (реальный расчет СДЭК сложен для JS)
            const deliveryPrice = type === 'sdek_pvz' ? 300 : 500; 
            
            const goodsSum = cart.reduce((sum, item) => sum + item.price, 0);
            let discountSum = 0;
            
            if (activePromo) {
                discountSum = Math.round(goodsSum * (activePromo.discount / 100));
            }
            
            const total = goodsSum - discountSum + deliveryPrice;

            document.getElementById('sum-goods').innerText = goodsSum + ' ₽';
            document.getElementById('sum-delivery').innerText = deliveryPrice + ' ₽';
            document.getElementById('sum-discount').innerText = '-' + discountSum + ' ₽';
            document.getElementById('sum-total').innerText = total + ' ₽';
            document.getElementById('pay-amount').innerText = total + ' ₽'; // Для экрана оплаты
            
            return { goodsSum, deliveryPrice, discountSum, total, type };
        }

        function goPayment() {
            if(!document.getElementById('policy').checked) return tg.showAlert("Нужно согласие с политикой!");
            if(!document.getElementById('city').value) return tg.showAlert("Введите город!");
            if(!document.getElementById('fio').value) return tg.showAlert("Введите ФИО!");
            
            showView('view-payment');
        }

        function finishOrder() {
            const financials = calcDelivery();
            
            const data = {
                type: "full_order", // Метка для бота
                user: {
                    fio: document.getElementById('fio').value,
                    phone: document.getElementById('phone').value,
                    city: document.getElementById('city').value,
                    address: document.getElementById('pvz-address').value
                },
                cart: cart,
                promo: activePromo ? activePromo.code : null,
                financials: financials
            };

            tg.sendData(JSON.stringify(data));
        }
    </script>
</body>
</html>